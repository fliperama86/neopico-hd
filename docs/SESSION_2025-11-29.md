# Session Summary - 2025-11-29

## Mission: Extend 2-bit R+G capture to 3-bit R+G+B

**Initial Status**: Working 2-bit R+G capture, wanted to add B channel for full RGB
**Final Status**: ‚úÖ 4-bit R+G+B+GND capture working perfectly with crystal-clear 8-color output

---

## The Problem: 3-Bit Capture Failed

### What We Tried
1. Extended 2-bit PIO program from `in pins, 2` to `in pins, 3`
2. Updated extraction logic to handle 3 bits per pixel
3. Result: **Consistent glitching with row-wise pixel drifting**

### Root Cause Discovered
PIO autopush (32-bit words) is incompatible with 3-bit pixels:
```
32 bits √∑ 3 bits/pixel = 10.67 pixels (MISALIGNED!)
```

This misalignment causes pixel data to unpredictably span word boundaries, creating systematic corruption that's unfixable without architectural changes.

---

## The Breakthrough: 4-Bit Solution

### Key Insight
GPIO 5 is already tied to ground - we can use it as a **dummy 4th bit for alignment**!

```
32 bits √∑ 4 bits/pixel = 8 pixels (PERFECT ALIGNMENT!)
```

### Implementation
1. Changed PIO to capture 4 bits: `in pins, 4` (R4, G4, B4, GND)
2. Updated extraction to read 4 bits, mask to 3 bits, discard dummy
3. Changed output format from PGM (grayscale) to PPM (8-color RGB)
4. Result: **Crystal-clear King of Fighters screenshot with perfect colors**

---

## Technical Details

### PIO Program
```asm
.program mvs_pixel_capture
    wait 1 irq 4
.wrap_target
    wait 0 gpio 1
    wait 1 gpio 1
    in pins, 4      ; Sample 4 pins (R, G, B, GND)
.wrap
```

### C Code Extraction
```c
// Extract 4 bits (R, G, B, GND) and mask to 3 bits (R, G, B)
uint8_t pixel_4bit = (raw_pixel_buffer[word_idx] >> bit_idx) & 15;
uint8_t pixel_rgb = pixel_4bit & 7;  // Discard GND bit
pixel_buffer[out_pixel_idx] = pixel_rgb;
```

### Output Format
- **Format**: PPM (P3) with ASCII RGB triplets
- **Colors**: 8 colors (3-bit RGB: 2¬≥ combinations)
- **Quality**: Crystal-clear, no artifacts, deterministic

---

## Alignment Mathematics Explained

Why certain pixel depths work or fail:

| Bits/Pixel | 32√∑Bits | Result | Status |
| --- | --- | --- | --- |
| 1 | 32√∑1 | 32.00 | ‚úÖ Works (integer) |
| 2 | 32√∑2 | 16.00 | ‚úÖ Works (proven) |
| 3 | 32√∑3 | 10.67 | ‚ùå Broken (fractional) |
| 4 | 32√∑4 | 8.00 | ‚úÖ Works (proven) |
| 5 | 32√∑5 | 6.40 | ‚ùå Broken (fractional) |
| 8 | 32√∑8 | 4.00 | ‚úÖ Works (integer) |

**Rule**: Only divisors of 32 work perfectly: 1, 2, 4, 8, 16, 32

---

## Lessons Learned

### What Worked Well ‚úÖ
- **Baby steps approach**: Validated 2-bit before attempting 3-bit
- **Mathematical analysis**: Identified exact alignment issue
- **Creative problem-solving**: Used existing GPIO (5 = GND) as dummy bit
- **Rapid iteration**: Quick compile-deploy-test cycle

### What Didn't Work ‚ùå
- **Direct 3-bit approach**: Mathematically impossible with 32-bit autopush
- **Custom post-processing**: Can't fix misaligned word boundaries in software

### Why This Matters
3-bit captures are fundamentally incompatible with RP2040's 32-bit PIO autopush. The 4-bit solution is elegant because:
1. Perfect alignment at minimal cost
2. Uses existing unused GPIO (no new wiring)
3. Simple masking in post-processing
4. Crystal-clear results

---

## Next Steps

### Immediate (Future Sessions)
1. Full 15-bit RGB (all 5 bits per channel)
   - Would require new architecture (multiple captures or DMA buffering)
2. Continuous frame streaming
3. DARK/SHADOW signal support

### Long-Term
1. Multi-frame capture for animation
2. Frame statistics (brightness analysis)
3. Sprite extraction
4. Game-specific event detection

---

## Files Modified

- **src/main.c**
  - Updated extraction code for 4-bit (lines 213-258)
  - Changed from PGM (grayscale) to PPM (color) output
  - Updated buffer indexing and offset calculations

- **docs/3BIT_RGB_FINDINGS.md** (NEW)
  - Documented why 3-bit failed
  - Explained 4-bit solution
  - Created alignment mathematics reference table

- **docs/PROJECT_STATUS.md**
  - Marked Phase 5 as COMPLETE
  - Updated version to 1.0
  - Updated success criteria

---

## Commit

```
683ec0b - Phase 5 complete: 4-bit RGB capture working perfectly!
```

---

## Performance Summary

| Metric | Value |
| --- | --- |
| **Capture resolution** | 320√ó224 pixels |
| **Color depth** | 3-bit RGB (8 colors) |
| **Frame rate** | ~59 fps (1 frame per 5 seconds to USB) |
| **Capture time** | ~17ms per frame |
| **Memory usage** | ~72 KB frame buffer (27% of RAM) |
| **Output format** | PPM ASCII (P3) |
| **Image quality** | Crystal-clear, readable text |
| **Alignment jitter** | ¬±0 pixels (hardware IRQ sync) |

---

## Conclusion

‚úÖ **Phase 5 Complete: Production-ready 3-bit RGB color capture**

The journey from 2-bit to 3-bit revealed a fundamental architectural constraint in the RP2040 PIO autopush mechanism. Rather than trying to overcome it, we embraced it by using 4-bit capture with a dummy GND bit. This elegant solution provides perfect alignment, clean output, and minimal complexity.

The project is now at **v1.0** with deterministic, jitter-free, color video capture working flawlessly!

üéÆ **Happy capturing!**
